#!/usr/bin/env python

import sys
import logging
from argparse import ArgumentParser

parser = ArgumentParser(description = 'Update site status.')
parser.add_argument('--config', '-c', metavar = 'CONFIG', dest = 'config', required = True, help = 'Configuration JSON.')

args = parser.parse_args()
sys.argv = []

## Load the configuration
from dynamo.dataformat import Configuration

config = Configuration(args.config)

## Set up logging (write to stdout)
from dynamo.core.executable import make_standard_logger

LOG = make_standard_logger(config.log_level)

## Load and initialize sources
from dynamo.core.executable import inventory
import dynamo.source.impl as sources

config.sites.config.phedex = config.phedex

site_source = sources.PhEDExSiteInfoSource(config.sites.config)

## Start the update

for site in inventory.sites:
    current_status = site_source.get_site_status(site.name)
    if current_status != site.status:
        site.status = current_status
        inventory.update(site)

LOG.info('Site update completed.')
