#!/usr/bin/env python

import os
import sys
from argparse import ArgumentParser

parser = ArgumentParser(description = 'Update subscriptions.')
parser.add_argument('--config', '-c', metavar = 'CONFIG', dest = 'config', help = 'Configuration JSON.')

args = parser.parse_args()
sys.argv = []

## Load the configuration
from dynamo.dataformat.configuration import Configuration

config = Configuration(args.config)

## Set up logging (write to stdout & stderr)
from dynamo.core.executable import make_standard_logger, read_only, inventory

LOG = make_standard_logger(config.get('log_level', 'info'))

## Set up a handle to the RLFSM
from dynamo.fileop.rlfsm import RLFSM

rlfsm = RLFSM(config.get('rlfsm', None))

if read_only:
    rlfsm.set_read_only()

## Set up a handle to the registry
from dynamo.registry.registry import RegistryDatabase

registry = RegistryDatabase()

## Run
from dynamo.dataformat import File

LOG.info('Updating the inventory from injections.')

if not read_only:
    registry.db.lock_tables(write = ['data_injections'])

n_injected = 0
n_deleted = 0

for cmd, objstr in registry.db.xquery('SELECT `cmd`, `obj` FROM `data_injections` ORDER BY `id`'):
    obj = inventory.make_object(objstr)

    if cmd == 'update':
        embedded_obj = inventory.update(obj)
        n_injected += 1

        if type(obj) is File:
            block = embedded_obj.block
            for replica in block.replicas:
                rlfsm.subscribe_files(replica.site, embedded_obj)

    elif cmd == 'delete':
        inventory.delete(obj)
        n_deleted += 1

if not read_only:
    registry.db.query('DELETE FROM `data_injections`')
    registry.db.query('ALTER TABLE `data_injections` AUTO_INCREMENT = 1')

    registry.db.unlock_tables()

LOG.info('Injected %d objects and deleted %d objects.', n_injected, n_deleted)

LOG.info('Updating the inventory from transfers and deletions.')

rlfsm.update_inventory(inventory)

LOG.info('Inventory update completed.')
